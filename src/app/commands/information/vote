import { Command } from "@classes/Command";
import {
    ActionRowBuilder, AnyComponentBuilder, ApplicationCommandOptionType, Colors,
    ComponentType, EmbedBuilder, InteractionCollector,
    SelectMenuBuilder, SelectMenuComponent, SelectMenuComponentOptionData, SelectMenuInteraction, SelectMenuOptionBuilder
} from "discord.js";
export default new Command({
    name: "vote",
    nameLocalizations: { ru: "–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ" },
    description: "–°–æ–∑–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º",
    run: async ({ interaction }) => {
        if (!interaction.inCachedGuild) return
        const time = interaction.options.getNumber('time') || 15
        const question = interaction.options.getString('question')
        const alreadyVoted: Set<string> = new Set()

        const embed: EmbedBuilder = new EmbedBuilder()
            .setAuthor({ name: interaction.user.username, iconURL: interaction.user.displayAvatarURL() })
            .setColor(Colors.Green)
            .setFooter({ text: "–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–ø—Ä–æ—Å–∞" })
            .setTimestamp(Date.now() + time * 60 * 1000)

        if (question.length <= 256) embed.setTitle(question)
        else embed.setDescription(question)

        const answerPrefixes: string[] = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th']
        const emojis: string[] = ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£", "üîü"]
        const voited: number[] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

        function createMessageActionRow(disabled?: boolean): ActionRowBuilder<SelectMenuBuilder> {
            const answers: string[] = answerPrefixes.map(x => {
                return interaction.options.getString(`${x}_answer`)
            }).filter(x => x)

            const selectComponents: SelectMenuComponentOptionData[] = answers.map((x, i) => {
                return {
                    label: `[${voited[i]}] ${answers[i]}`,
                    value: answerPrefixes[i],
                    emoji: emojis[i]
                }
            })

            const selectMenu: SelectMenuBuilder = new SelectMenuBuilder()
                .addOptions(selectComponents)
                .setCustomId(`vote_${interaction.id}`)
            if (disabled) selectMenu.setCustomId(`vote_disabled_${(Date.now() / 1000) + time}`).setPlaceholder(`–û–ø—Ä–æ—Å –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω`)
            const actionRow: ActionRowBuilder<SelectMenuBuilder> = new ActionRowBuilder<SelectMenuBuilder>().addComponents(selectMenu)
            return actionRow
        }

        const oldActionRow = createMessageActionRow()

        interaction.reply({ embeds: [embed], components: [oldActionRow] })

        const collector: InteractionCollector<SelectMenuInteraction> = interaction.channel.createMessageComponentCollector({
            filter: int => int.customId == `vote_${interaction.id}`,
            componentType: ComponentType.SelectMenu,
            time: 1000//time * 60 * 1000
        })

        collector.on('collect', async (int) => {
            if (!int.inCachedGuild()) return
            if (alreadyVoted.has(int.member.id)) {
                int.reply({ content: "<:disabled:918562727134371840> –í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏!", ephemeral: true })
                return
            }
            else int.reply({ content: "<:enabled:918562727314722917> –í–∞—à –≥–æ–ª–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!", ephemeral: true })

            voited[answerPrefixes.indexOf(int.values[0])] += 1
            alreadyVoted.add(int.member.id)

            const newActionRow: ActionRowBuilder<SelectMenuBuilder> = createMessageActionRow()
            interaction.editReply({ embeds: [embed], components: [newActionRow] })
        })

        collector.on(`end`, (int, reason) => {
            const newestActionRow: ActionRowBuilder<SelectMenuBuilder> = createMessageActionRow(true)
            interaction.editReply({ embeds: [embed], components: [newestActionRow] })
        })
    },
    options: [
        {
            name: "question",
            nameLocalizations: { ru: "–≤–æ–ø—Ä–æ—Å" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º",
            type: ApplicationCommandOptionType.String,
            required: true,
            minLength: 5,
            maxLength: 500
        }, {
            name: "1st_answer",
            nameLocalizations: { ru: "–ø–µ—Ä–≤—ã–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            required: true,
            maxLength: 100
        }, {
            name: "2nd_answer",
            nameLocalizations: { ru: "–≤—Ç–æ—Ä–æ–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ç–æ—Ä–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            required: true,
            maxLength: 100
        }, {
            name: "3rd_answer",
            nameLocalizations: { ru: "—Ç—Ä–µ—Ç–∏–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ç—Ä–µ—Ç—å–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            maxLength: 100
        }, {
            name: "4th_answer",
            nameLocalizations: { ru: "—á–µ—Ç–≤–µ—Ä—Ç—ã–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            maxLength: 100
        }, {
            name: "5th_answer",
            nameLocalizations: { ru: "–ø—è—Ç—ã–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—è—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            maxLength: 100
        }, {
            name: "6th_answer",
            nameLocalizations: { ru: "—à–µ—Å—Ç–æ–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç —à–µ—Å—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            maxLength: 100
        }, {
            name: "7th_answer",
            nameLocalizations: { ru: "—Å–µ–ª—å–º–æ–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–µ–¥—å–º–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            maxLength: 100
        }, {
            name: "8th_answer",
            nameLocalizations: { ru: "–≤–æ—Å—å–º–æ–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ—Å—å–º–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            maxLength: 100
        }, {
            name: "9th_answer",
            nameLocalizations: { ru: "–¥–µ–≤—è—Ç—ã–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–µ–≤—è—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            maxLength: 100
        }, {
            name: "10th_answer",
            nameLocalizations: { ru: "–¥–µ—Å—è—Ç—ã–π_–≤–∞—Ä–∏–∞–Ω—Ç" },
            description: "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–µ—Å—è—Ç–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞",
            type: ApplicationCommandOptionType.String,
            maxLength: 100
        }, {
            name: "time",
            nameLocalizations: { ru: "–≤—Ä–µ–º—è" },
            description: "–£–∫–∞–∂–∏—Ç–µ –≤ –º–∏–Ω—É—Ç–∞—Ö —Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω –æ–ø—Ä–æ—Å (–º–∞–∫—Å–∏–º—É–º 1 —á–∞—Å)",
            type: ApplicationCommandOptionType.Number,
            minValue: 1,
            maxValue: 60,
            required: false
        }
    ],

})